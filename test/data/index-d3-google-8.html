<!DOCTYPE html>
<html>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Draggable directions</title>
    <style>
        #right-panel {
            font-family: 'Roboto', 'sans-serif';
            line-height: 30px;
            padding-left: 10px;
            padding-right: 20px;
        }

        #right-panel select, #right-panel input {
            font-size: 15px;
        }

        #right-panel select {
            width: 100%;
        }

        #right-panel i {
            font-size: 12px;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100%;
            float: left;
            width: 63%;
            height: 100%;
        }

        #right-panel {
            float: right;
            width: 34%;
            height: 100%;
        }

        .panel {
            height: 100%;
            overflow: auto;
        }

        .stations, .stations svg {
            position: absolute;
        }

        .stations svg {
            width: 60px;
            height: 20px;
            padding-right: 100px;
            font: 10px sans-serif;
        }

        .stations circle {
            fill: brown;
            stroke: black;
            stroke-width: 1.5px;
        }

        .airports, .airports svg {
            position: absolute;
        }

        .airports svg {
            width: 60px;
            height: 20px;
            padding-right: 100px;
            font: 10px sans-serif;
        }

        .airports circle {
            fill: #009aff;
            stroke: black;
            stroke-width: 1.5px;
        }


    </style>
</head>
<body>
<div id="map"></div>
<div id="right-panel">
    <p>Total Distance: <span id="total"></span></p>

    <select id="parlamentares-select" onchange="initMap(this.value)">
    </select>

    <input type="range" min="2014" max="2017" value="2014" step="1" onchange="showValue(this)"/>
    <span id="range">2014</span>
    <script type="text/javascript">
        function showValue(newValue) {
            document.getElementById("range").innerHTML = newValue;
        }
    </script>
</div>
<script>

    var parlamentares = [];
    function initMap(indexParlamentarSelected) {

        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 3,
            draggableCursor: 'url(http://powerhut.co.uk/googlemaps/marker-images/image.png), crosshair',
            center: new google.maps.LatLng(-14.2350, -51.9253)//{lat: -14.2350, lng: 51.9253}  // Australia.
        });

        /*var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer({
            draggable: true,
            map: map
            //panel: document.getElementById('right-panel')
        });

        directionsDisplay.addListener('directions_changed', function () {
            computeTotalDistance(directionsDisplay.getDirections());
        });

        displayRoute('Perth, WA', 'Sydney, NSW', directionsService,
            directionsDisplay);


        var flightPlanCoordinates = [
            new google.maps.LatLng(37.772323, -122.214897),
            new google.maps.LatLng(21.291982, -157.821856)
        ];
        var flightPath = new google.maps.Polyline({
            path: flightPlanCoordinates,
            strokeColor: "#FF0000",
            strokeOpacity: 1.0,
            strokeWeight: 2
        });

        var flightPlanCoordinates1 = [
            new google.maps.LatLng(-18.142599, 178.431),
            new google.maps.LatLng(-27.46758, 153.027892)
        ];
        var flightPath1 = new google.maps.Polyline({
            path: flightPlanCoordinates1,
            strokeColor: "#347bff",
            strokeOpacity: 1.0,
            strokeWeight: 2
        });

        google.maps.event.addListener(flightPath, "mouseover", function () {
            console.log('mouse over path');
            var flightPath = new google.maps.Polyline({
                path: flightPlanCoordinates,
                strokeColor: "#FFFF00",
                strokeOpacity: 1.0,
                strokeWeight: 2
            });
            flightPath.setMap(map);
        });

        google.maps.event.addListener(flightPath, "mouseout", function () {
            console.log('mouse out path');
            var flightPath = new google.maps.Polyline({
                path: flightPlanCoordinates,
                strokeColor: "#FF0000",
                strokeOpacity: 1.0,
                strokeWeight: 2
            });
            flightPath.setMap(map);
        });

        var image = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png';
        var beachMarker = new google.maps.Marker({
            position: {lat: -33.890, lng: 151.274},
            map: map,
            icon: image
        });

        map.addListener('click', function (e) {
            placeMarker(e.latLng, map);
        });
*/
        d3.queue()
            .defer(d3.json, "us-10m.json")
            .defer(d3.csv, "world-airport-codes.csv", typeAirport)
            .defer(d3.csv, "Ano-2017-parsed.csv", typeFlight)
            .await(ready);


        function ready(error, us, airports, flights) {
            if (error) throw error;

            var airportByIata = d3.map(airports, function (d) {
                return d.iata_code;
            });

            if(parlamentares == null){

                parlamentares = [];
            }

            // check which airports really have flights from our dataset
            flights.forEach(function (flight) {
                if(indexParlamentarSelected != null && flight.name == parlamentares[indexParlamentarSelected]){
                    var source = airportByIata.get(flight.origin),
                        target = airportByIata.get(flight.destination);
                    if (source != null && target != null) {
                        source.arcs.coordinates.push([source, target]);
                        target.arcs.coordinates.push([target, source]);


                        console.log('orig: ' + flight.origin + ' - dest: ' + flight.destination);
                        console.log('source: ' , source[0] + ' - target: ' , target);
                        // try with source and target
                        var flightPlanCoordinates3 = [
                            new google.maps.LatLng(source.latitude_deg, source.longitude_deg),
                            new google.maps.LatLng(target.latitude_deg, target.longitude_deg)
                        ];
                        var flightPath3 = new google.maps.Polyline({
                            path: flightPlanCoordinates3,
                            strokeColor: "#008eff",
                            strokeOpacity: 1.0,
                            strokeWeight: 2
                        });

                        flightPath3.setMap(map);

                    }
                }
                if (!contains.call(parlamentares, flight.name)) {
                    parlamentares[parlamentares.length] = flight.name;
                }

            });

            //console.log(parlamentares[indexParlamentarSelected]);

            airports = airports
                .filter(function (d) {
                    return d.arcs.coordinates.length;
                });

            // adding parlamentares names to list
            // TODO ensure names are not repeated
            var select = document.getElementById("parlamentares-select");
            for (index in parlamentares) {
                select.options[select.options.length] = new Option(parlamentares[index], index);
            }


            // trying to add airport points
            var overlay = new google.maps.OverlayView();

            // Add the container when the overlay is added to the map.
            overlay.onAdd = function () {
                var layer = d3.select(this.getPanes().overlayLayer).append("div")
                    .attr("class", "airports");

                // Draw each marker as a separate SVG element.
                // We could use a single SVG, but what size would it have?
                overlay.draw = function () {
                    var projection = this.getProjection(),
                        padding = 10;


                    //console.log('this: ' , this);

                    var marker = layer.selectAll("svg")
                        .data(d3.entries(airports))
                        .each(transform) // update existing markers
                        .enter().append("svg")
                        .each(transform)
                        .attr("class", "marker");

                    // Add a circle.
                    marker.append("circle")
                        .attr("r", 4.5)
                        .attr("cx", padding)
                        .attr("cy", padding);

                    // Add a label.
                    marker.append("text")
                        .attr("x", padding + 7)
                        .attr("y", padding)
                        .attr("dy", ".31em")
                        .text(function (d) {
                            return d.iata;
                        });

                    function transform(d) {
                        d = new google.maps.LatLng(d.value[1], d.value[0]);
                        d = projection.fromLatLngToDivPixel(d);
                        return d3.select(this)
                            .style("left", (d.x - padding) + "px")
                            .style("top", (d.y - padding) + "px");
                    }
                };
            };

            // Bind our overlay to the mapâ€¦
            overlay.setMap(map);
            // end of airport points
        }


        //flightPath.setMap(map);

        //flightPath1.setMap(map);

    }

    var contains = function (needle) {
        // Per spec, the way to identify NaN is that it is not equal to itself
        var findNaN = needle !== needle;
        var indexOf;

        if (!findNaN && typeof Array.prototype.indexOf === 'function') {
            indexOf = Array.prototype.indexOf;
        } else {
            indexOf = function (needle) {
                var i = -1, index = -1;

                for (i = 0; i < this.length; i++) {
                    var item = this[i];

                    if ((findNaN && item !== item) || item === needle) {
                        index = i;
                        break;
                    }
                }
                return index;
            };
        }

        return indexOf.call(this, needle) > -1;
    };

    function placeMarker(latLng, map) {
        var marker = new google.maps.Marker({
            position: latLng,
            map: map
        });
    }

    function displayRoute(origin, destination, service, display) {
        service.route({
            origin: origin,
            destination: destination,
            waypoints: [{location: 'Melbourne, NSW'}, {location: 'Broken Hill, NSW'}],
            travelMode: 'DRIVING',
            avoidTolls: true
        }, function (response, status) {
            if (status === 'OK') {
                display.setDirections(response);
            } else {
                alert('Could not display directions due to: ' + status);
            }
        }, function (response, status) {
            if (status === 'OK') {
                display.setDirections(response);
            } else {
                alert('Could not display directions due to: ' + status);
            }
        });
    }

    function typeAirport(d) {
        d[0] = +d.longitude_deg;
        d[1] = +d.latitude_deg;
        d.arcs = {type: "MultiLineString", coordinates: []};
        return d;
    }

    function typeFlight(d) {
        d.count = +d.count;
        return d;
    }

    function computeTotalDistance(result) {
        var total = 0;
        var myroute = result.routes[0];
        for (var i = 0; i < myroute.legs.length; i++) {
            total += myroute.legs[i].distance.value;
        }
        total = total / 1000;
        document.getElementById('total').innerHTML = total + ' km';
    }
</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHvjraZ_YQXZvFg8etDFaKUxp3EG1-DOs&callback=initMap">
</script>
</body>
</html>